/*! WysiBB - WYSIWYG BBCode editor - v1.0.2 - 2012-09-03
* http://www.wysibb.com
* Copyright (c) 2012 Vadim Dobroskok; Licensed MIT, GPL */
if(typeof(WBBLANG)=="undefined"){WBBLANG={}}var CURLANG={bold:"Полужирный",italic:"Курсив",underline:"Подчеркнутый",strike:"Зачеркнутый",link:"Ссылка",img:"Изображение",sup:"Надстрочный текст",sub:"Подстрочный текст",justifyleft:"Текст по левому краю",justifycenter:"Текст по центру",justifyright:"Текст по правому краю",table:"Вставить таблицу",bullist:"Обычный список",numlist:"Нумерованный список",quote:"Цитата",offtop:"Оффтоп",code:"Код",spoiler:"Сворачиваемый текст",fontcolor:"Цвет текста",fontsize:"Размер текста",fontfamily:"Шрифт текста",fs_verysmall:"Очень маленький",fs_small:"Маленький",fs_normal:"Нормальный",fs_big:"Большой",fs_verybig:"Очень большой",smilebox:"Вставить смайл",video:"Вставить видео",modal_link_title:"Вставить ссылку",modal_link_text:"Отображаемый текст",modal_link_url:"URL ссылки",modal_email_text:"Отображаемый эл.адрес",modal_email_url:"Email",modal_link_tab1:"Вставить URL",modal_img_title:"Вставить изображение",modal_img_tab1:"Ввести URL",modal_img_tab2:"Загрузить файл",modal_imgsrc_text:"Введите адрес изображения",modal_img_btn:"Выберите изображение для загрузки",modal_video_text:"Введите URL видео",close:"Закрыть",save:"Сохранить",cancel:"Отмена",remove:"Удалить",validation_err:"Введенные данные некорректны",error_onupload:"Ошибка во время загрузки файла",fileupload_text1:"Перетащите изображение сюда",fileupload_text2:"или",loading:"Загрузка",auto:"Авто",sm1:"Улыбка",sm2:"Смех",sm3:"Подмигивание",sm4:"Спасибо, класс",sm5:"Ругаю",sm6:"Шок",sm7:"Злой",sm8:"Огорчение",sm9:"Тошнит"};(function(a){a.wysibb=function(c,b){this.startTime=(new Date()).getTime();this.debug("Start");a(c).data("wbb",this);if(b&&b.deflang&&typeof(WBBLANG[b.deflang])!="undefined"){CURLANG=WBBLANG[b.deflang]}if(b&&b.lang&&typeof(WBBLANG[b.lang])!="undefined"){CURLANG=WBBLANG[b.lang]}this.txtArea=c;this.$txtArea=a(c);var d=this.$txtArea.attr("id")||this.setUID(this.txtArea);this.options={version:"1.0.2",bbmode:false,onlyBBmode:false,themeName:"default",bodyClass:"",lang:"ru",tabInsert:true,imgupload:true,img_uploadurl:"/iupload.php",img_maxwidth:800,img_maxheight:800,hotkeys:true,showHotkeys:true,autoresize:true,disablePageStyles:false,editorStyles:[],resize_maxheight:800,buttons:"bold,italic,underline,strike,sup,sub,|,img,link,|,bullist,numlist,smilebox,|,fontcolor,fontsize,fontfamily,|,justifyleft,justifycenter,justifyright,|,quote,code,offtop,table",allButtons:{bold:{title:CURLANG.bold,buttonHTML:'<span class="ve-tlb-bold"></span>',excmd:"bold",hotkey:"ctrl+b",transform:{"<b>{SELTEXT}</b>":"[b]{SELTEXT}[/b]","<strong>{SELTEXT}</strong>":"[b]{SELTEXT}[/b]"}},italic:{title:CURLANG.italic,buttonHTML:'<span class="ve-tlb-italic"></span>',excmd:"italic",hotkey:"ctrl+i",transform:{"<i>{SELTEXT}</i>":"[i]{SELTEXT}[/i]","<em>{SELTEXT}</em>":"[i]{SELTEXT}[/i]"}},underline:{title:CURLANG.underline,buttonHTML:'<span class="ve-tlb-underline"></span>',excmd:"underline",hotkey:"ctrl+u",transform:{"<u>{SELTEXT}</u>":"[u]{SELTEXT}[/u]"}},strike:{title:CURLANG.strike,buttonHTML:'<span class="ve-tlb-strike"></span>',excmd:"strikeThrough",transform:{"<strike>{SELTEXT}</strike>":"[s]{SELTEXT}[/s]","<s>{SELTEXT}</s>":"[s]{SELTEXT}[/s]"}},sup:{title:CURLANG.sup,buttonHTML:'<span class="ve-tlb-sup"></span>',excmd:"superscript",transform:{"<sup>{SELTEXT}</sup>":"[sup]{SELTEXT}[/sup]"}},sub:{title:CURLANG.sub,buttonHTML:'<span class="ve-tlb-sub"></span>',excmd:"subscript",transform:{"<sub>{SELTEXT}</sub>":"[sub]{SELTEXT}[/sub]"}},link:{title:CURLANG.link,buttonHTML:'<span class="ve-tlb-link"></span>',hotkey:"ctrl+shift+2",modal:{title:CURLANG.modal_link_title,width:"500px",tabs:[{input:[{param:"SELTEXT",title:CURLANG.modal_link_text},{param:"URL",title:CURLANG.modal_link_url,validation:"^http(s)?://"}]}]},transform:{'<a href="{URL}">{SELTEXT}</a>':"[url={URL}]{SELTEXT}[/url]"}},img:{title:CURLANG.img,buttonHTML:'<span class="ve-tlb-img"></span>',hotkey:"ctrl+shift+1",modal:{title:CURLANG.modal_img_title,width:"600px",tabs:[{title:CURLANG.modal_img_tab1,input:[{param:"SRC",title:CURLANG.modal_imgsrc_text,validation:"^http(s)?://.*?.(jpg|png|gif|jpeg)$"}]},{title:CURLANG.modal_img_tab2,html:'<div id="imguploader"> <form id="fupform" class="upload" action="{img_uploadurl}" method="post" enctype="multipart/form-data" target="fupload"><input type="hidden" name="iframe" value="1"/><input type="hidden" name="idarea" value="'+d+'" /><div class="fileupload"><input id="fileupl" class="file" type="file" name="img" /><button id="nicebtn" class="wbb-button">'+CURLANG.modal_img_btn+'</button> </div> </form> </div><iframe id="fupload" name="fupload" src="about:blank" frameborder="0" style="width:0px;height:0px;display:none"></iframe></div>'}],onLoad:this.imgLoadModal},transform:{'<img src="{SRC}" />':"[img]{SRC}[/img]",'<img src="{SRC}" width="{WIDTH}" height="{HEIGHT}"/>':"[img width={WIDTH},height={HEIGHT}]{SRC}[/img]"}},bullist:{title:CURLANG.bullist,buttonHTML:'<span class="ve-tlb-list"></span>',excmd:"insertUnorderedList",transform:{"<ul>{SELTEXT}</ul>":"[list]{SELTEXT}[/list]","<li>{SELTEXT}</li>":"[*]{SELTEXT}[/*]"}},numlist:{title:CURLANG.numlist,buttonHTML:'<span class="ve-tlb-numlist"></span>',excmd:"insertOrderedList",transform:{"<ol>{SELTEXT}</ol>":"[list=1]{SELTEXT}[/list]","<li>{SELTEXT}</li>":"[*]{SELTEXT}[/*]"}},quote:{title:CURLANG.quote,buttonHTML:'<span class="ve-tlb-quote"></span>',hotkey:"ctrl+shift+3",transform:{'<div class="quote"><blockquote>{SELTEXT}</blockquote></div>':"[quote]{SELTEXT}[/quote]"}},code:{title:CURLANG.code,buttonText:"[code]",hotkey:"ctrl+shift+4",transform:{'<div class="codewrap"><div class="codetop">Код:</div><div class="codemain">{SELTEXT}</div></div>':"[code]{SELTEXT}[/code]"}},offtop:{title:CURLANG.offtop,buttonText:"offtop",transform:{'<span style="font-size:10px;color:#ccc">{SELTEXT}</span>':"[offtop]{SELTEXT}[/offtop]"}},fontcolor:{type:"colorpicker",title:CURLANG.fontcolor,excmd:"foreColor",valueBBname:"color",subInsert:true,colors:"#000000,#444444,#666666,#999999,#b6b6b6,#cccccc,#d8d8d8,#efefef,#f4f4f4,#ffffff,-, 							 #ff0000,#980000,#ff7700,#ffff00,#00ff00,#00ffff,#1e84cc,#0000ff,#9900ff,#ff00ff,-, 							 #f4cccc,#dbb0a7,#fce5cd,#fff2cc,#d9ead3,#d0e0e3,#c9daf8,#cfe2f3,#d9d2e9,#ead1dc, 							 #ea9999,#dd7e6b,#f9cb9c,#ffe599,#b6d7a8,#a2c4c9,#a4c2f4,#9fc5e8,#b4a7d6,#d5a6bd, 							 #e06666,#cc4125,#f6b26b,#ffd966,#93c47d,#76a5af,#6d9eeb,#6fa8dc,#8e7cc3,#c27ba0, 							 #cc0000,#a61c00,#e69138,#f1c232,#6aa84f,#45818e,#3c78d8,#3d85c6,#674ea7,#a64d79, 							 #900000,#85200C,#B45F06,#BF9000,#38761D,#134F5C,#1155Cc,#0B5394,#351C75,#741B47, 							 #660000,#5B0F00,#783F04,#7F6000,#274E13,#0C343D,#1C4587,#073763,#20124D,#4C1130",transform:{'<font color="{COLOR}">{SELTEXT}</font>':"[color={COLOR}]{SELTEXT}[/color]"}},table:{type:"table",title:CURLANG.table,cols:10,rows:10,cellwidth:15,transform:{"<td>{SELTEXT}</td>":"[td]{SELTEXT}[/td]","<tr>{SELTEXT}</tr>":"[tr]{SELTEXT}[/tr]",'<table class="wbb-table">{SELTEXT}</table>':"[table]{SELTEXT}[/table]"},skipRules:true},fontsize:{type:"select",title:CURLANG.fontsize,options:"fs_verysmall,fs_small,fs_normal,fs_big,fs_verybig"},fontfamily:{type:"select",title:CURLANG.fontfamily,excmd:"fontName",valueBBname:"font",options:[{title:"Arial",exvalue:"Arial"},{title:"Comic Sans MS",exvalue:"Comic Sans MS"},{title:"Courier New",exvalue:"Courier New"},{title:"Georgia",exvalue:"Georgia"},{title:"Lucida Sans Unicode",exvalue:"Lucida Sans Unicode"},{title:"Tahoma",exvalue:"Tahoma"},{title:"Times New Roman",exvalue:"Times New Roman"},{title:"Trebuchet MS",exvalue:"Trebuchet MS"},{title:"Verdana",exvalue:"Verdana"}],transform:{'<font face="{FONT}">{SELTEXT}</font>':"[font={FONT}]{SELTEXT}[/font]"}},smilebox:{type:"smilebox",title:CURLANG.smilebox,buttonHTML:'<span class="ve-tlb-smilebox"></span>'},justifyleft:{title:CURLANG.justifyleft,buttonHTML:'<span class="ve-tlb-textleft"></span>',transform:{'<div align="left">{SELTEXT}</div>':"[left]{SELTEXT}[/left]"}},justifyright:{title:CURLANG.justifyright,buttonHTML:'<span class="ve-tlb-textright"></span>',transform:{'<div align="right">{SELTEXT}</div>':"[right]{SELTEXT}[/right]"}},justifycenter:{title:CURLANG.justifycenter,buttonHTML:'<span class="ve-tlb-textcenter"></span>',transform:{'<div align="center">{SELTEXT}</div>':"[center]{SELTEXT}[/center]"}},video:{title:CURLANG.video,buttonHTML:'<span class="ve-tlb-video"></span>',modal:{title:CURLANG.video,width:"600px",tabs:[{title:CURLANG.video,input:[{param:"SRC",title:CURLANG.modal_video_text}]}],onSubmit:function(j,h,g){var f=this.$modal.find('input[name="SRC"]').val();var e=f.match(/^http:\/\/www\.youtube\.com\/watch\?v=([a-z0-9_]+)/i);if(e&&e.length==2){var i=e[1];this.insertAtCursor(this.getCodeByCommand(j,{src:i}))}this.closeModal();return false}},transform:{'<iframe src="http://www.youtube.com/embed/{SRC}" width="640" height="480" frameborder="0"></iframe>':"[video]{SRC}[/video]"}},fs_verysmall:{title:CURLANG.fs_verysmall,buttonText:"fs1",excmd:"fontSize",exvalue:"1",transform:{'<font size="1">{SELTEXT}</font>':"[size=50]{SELTEXT}[/size]"}},fs_small:{title:CURLANG.fs_small,buttonText:"fs2",excmd:"fontSize",exvalue:"2",transform:{'<font size="2">{SELTEXT}</font>':"[size=85]{SELTEXT}[/size]"}},fs_normal:{title:CURLANG.fs_normal,buttonText:"fs3",excmd:"fontSize",exvalue:"3",transform:{'<font size="3">{SELTEXT}</font>':"[size=100]{SELTEXT}[/size]"}},fs_big:{title:CURLANG.fs_big,buttonText:"fs4",excmd:"fontSize",exvalue:"4",transform:{'<font size="4">{SELTEXT}</font>':"[size=150]{SELTEXT}[/size]"}},fs_verybig:{title:CURLANG.fs_verybig,buttonText:"fs5",excmd:"fontSize",exvalue:"6",transform:{'<font size="6">{SELTEXT}</font>':"[size=200]{SELTEXT}[/size]"}}},systr:{"<br/>":"\n",'<span class="wbbtab"></span>':"   "},customRules:{td:[["[td]{SELTEXT}[/td]",{seltext:{rgx:false,attr:false,sel:false}}]],tr:[["[tr]{SELTEXT}[/tr]",{seltext:{rgx:false,attr:false,sel:false}}]],table:[["[table]{SELTEXT}[/table]",{seltext:{rgx:false,attr:false,sel:false}}]]},smileList:[{title:CURLANG.sm1,img:'<img src="{themePrefix}{themeName}/img/smiles/sm1.png" class="sm">',bbcode:":)"},{title:CURLANG.sm8,img:'<img src="{themePrefix}{themeName}/img/smiles/sm8.png" class="sm">',bbcode:":("},{title:CURLANG.sm1,img:'<img src="{themePrefix}{themeName}/img/smiles/sm2.png" class="sm">',bbcode:":D"},{title:CURLANG.sm3,img:'<img src="{themePrefix}{themeName}/img/smiles/sm3.png" class="sm">',bbcode:";)"},{title:CURLANG.sm4,img:'<img src="{themePrefix}{themeName}/img/smiles/sm4.png" class="sm">',bbcode:":up:"},{title:CURLANG.sm5,img:'<img src="{themePrefix}{themeName}/img/smiles/sm5.png" class="sm">',bbcode:":down:"},{title:CURLANG.sm6,img:'<img src="{themePrefix}{themeName}/img/smiles/sm6.png" class="sm">',bbcode:":shock:"},{title:CURLANG.sm7,img:'<img src="{themePrefix}{themeName}/img/smiles/sm7.png" class="sm">',bbcode:":angry:"},{title:CURLANG.sm9,img:'<img src="{themePrefix}{themeName}/img/smiles/sm9.png" class="sm">',bbcode:":sick:"}],attrWrap:["src","color","href"]};if(!this.options.themePrefix){a("link").each(a.proxy(function(e,g){var f=a(g).get(0).href.match(/(.*\/)(.*)\/wbbtheme\.css.*$/);if(f!==null){this.options.themeName=f[2];this.options.themePrefix=f[1]}},this))}if(typeof(WBBPRESET)!="undefined"){if(WBBPRESET.allButtons){a.each(WBBPRESET.allButtons,a.proxy(function(f,e){if(e.transform&&this.options.allButtons[f]){delete this.options.allButtons[f].transform}},this))}a.extend(true,this.options,WBBPRESET)}if(b&&b.allButtons){a.each(b.allButtons,a.proxy(function(f,e){if(e.transform&&this.options.allButtons[f]){delete this.options.allButtons[f].transform}},this))}a.extend(true,this.options,b);this.init()};a.wysibb.prototype={lastid:1,init:function(){this.debug("Init");this.isMobile=function(b){(/android.+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|meego.+mobile|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(b))}(navigator.userAgent||navigator.vendor||window.opera);if(this.isMobile){this.onlyBBmode=this.bbmode=true}this.controllers=[];this.options.buttons=this.options.buttons.toLowerCase();this.options.buttons=this.options.buttons.split(",");this.options.allButtons._systr={};this.options.allButtons._systr["transform"]=this.options.systr;this.smileFind();this.initTransforms();this.build();this.initModal();if(this.options.hotkeys===true&&!this.isMobile){this.initHotkeys()}this.options.smileList.sort(function(d,c){return(c.bbcode.length-d.bbcode.length)});this.$txtArea.parents("form").bind("submit",a.proxy(function(){this.sync();return true},this));a.log(this);this.debug("Complete")},initTransforms:function(){a.log("Create rules for transform HTML=>BB");var f=this.options;if(!f.rules){f.rules={}}var k=f.buttons.slice();for(var g=0;g<k.length;g++){var e=f.allButtons[k[g]];if(!e){continue}if(e.type=="select"&&typeof(e.options)=="string"){var m=e.options.split(",");a.each(m,function(n,o){if(a.inArray(o,k)==-1){k.push(o)}})}if(e.transform&&e.skipRules!==true){for(var l in e.transform){var j=e.transform[l];a.each(f.attrWrap,function(o,n){l=l.replace(n+'="',"_"+n+'="')});var b=a(document.createElement("DIV")).append(a(this.elFromString(l,document)));var i=this.filterByNode(b.children());if(!e.excmd){if(!e.rootSelector){e.rootSelector=[]}e.rootSelector.push(i)}if(!e.bbSelector){e.bbSelector=[]}if(a.inArray(j,e.bbSelector)==-1){e.bbSelector.push(j)}if(typeof(f.rules[i])=="undefined"){f.rules[i]=[]}var h={};if(l.match(/\{\S+?\}/)){b.find("*").each(a.proxy(function(p,r){var q=this.getAttributeList(r);a.each(q,a.proxy(function(u,x){var s=a(r).attr(x);if(x.substr(0,1)=="_"){x=x.substr(1)}var w=s.match(/\{\S+?\}/g);if(w){for(var t=0;t<w.length;t++){var v=w[t].substr(1,w[t].length-2);var y=this.relFilterByNode(r,i);var z=(s!=w[t])?this.getRegexpReplace(s,w[t]):false;h[v.toLowerCase()]={sel:(y)?a.trim(y):false,attr:x,rgx:z}}}},this));var o=[];if(!a(r).is("iframe")){a(r).contents().filter(function(){return this.nodeType===3}).each(a.proxy(function(z,D){var A=D.textContent||D.data;if(typeof(A)=="undefined"){return true}var s=A.match(/\{\S+?\}/g);if(s){for(var C=0;C<s.length;C++){var x=s[C].substr(1,s[C].length-2);var v=this.relFilterByNode(r,i);var B=(A!=s[C])?this.getRegexpReplace(A,s[C]):false;var w=(v)?a.trim(v):false;if(a.inArray(w,o)>-1||a(D).parent().contents().size()>1){var t=a("<span>").html("{"+x+"}");this.setUID(t,"wbb");var u=(A.indexOf(x)+x.length)+1;var y=A.substr(u,A.length-u);D.data=A.substr(0,A.indexOf(x)-1);a(D).after(this.elFromString(y,document)).after(t);w=((w)?w+" ":"")+this.filterByNode(t);B=false}h[x.toLowerCase()]={sel:w,attr:false,rgx:B};o[o.length]=w}}},this))}o=null;var n=b.html();if(l!=n){delete e.transform[l];e.transform[n]=j;l=n}},this))}f.rules[i].push([j,h])}var d=a.map(e.transform,function(o,n){return n}).sort(function(o,n){return((n[0]||"").length-(o[0]||"").length)});e.bbcode=e.transform[d[0]];e.html=d[0]}}this.options.btnlist=k;a.extend(f.rules,this.options.customRules);a.each(f.systr,a.proxy(function(o,p){if(!o.match(/\{\S+?\}/)){var n=this.filterByNode(this.elFromString(o,document));f.rules[n]=[];f.rules[n].push([p,{}])}},this));f.srules={};a.each(f.smileList,a.proxy(function(n,q){var p=a(this.strf(q.img,f));var o=this.filterByNode(p);f.srules[o]=[q.bbcode,q.img]},this));for(var c in f.rules){this.options.rules[c].sort(function(o,n){return(n[0].length-o[0].length)})}},build:function(){a.log("Build editor");this.$editor=a("<div>").addClass("wysibb");this.$editor.insertAfter(this.txtArea).append(this.txtArea);this.startHeight=this.$txtArea.outerHeight();this.$txtArea.addClass("wysibb-texarea");this.buildToolbar();this.$txtArea.wrap('<div class="wysibb-text">');if(this.options.onlyBBmode===false){var b=this.$txtArea.outerHeight();this.$iFrame=a(this.strf('<iframe src="about:blank" class="wysibb-text-iframe" frameborder="0" style="height:{height}px;"></iframe>',{height:b}));this.$txtArea.hide();this.$iFrame.bind("load",a.proxy(function(){a.log("Frame loaded");this.framewindow=this.$iFrame.get(0).contentWindow;this.doc=this.framewindow.document;this.body=this.doc.body;this.$body=a(this.doc.body);var c=this.doc.getElementsByTagName("head")[0];this.$body.addClass("wysibb-body").addClass(this.options.bodyClass);if(!this.options.disablePageStyles){a("link[rel='stylesheet']").each(function(e,f){a(c).append(a(f).clone()[0].outerHTML)});a("style").each(function(e,f){a(c).append(a(f).clone()[0].outerHTML)})}if(typeof(this.options.editorStyles)!="undefined"){if(typeof(this.options.editorStyles)=="string"){a(c).append("<link rel='stylesheet' href='"+this.options.editorStyles+"'>")}else{a.each(this.options.editorStyles,function(e,f){a(c).append("<link rel='stylesheet' href='"+f+"'>")})}}if("contentEditable" in this.body){this.body.contentEditable=true;try{this.doc.execCommand("StyleWithCSS",false,false)}catch(d){}}else{this.options.onlyBBmode=this.options.bbmode=true}if(this.txtArea.value.length>0){this.$body.html(this.getHTML(this.txtArea.value,true))}a(this.doc).bind("keydown",a.proxy(function(h){if((h.which==86&&(h.ctrlKey==true||h.metaKey==true))||(h.which==45&&(h.shiftKey==true||h.metaKey==true))){var g=this.getRange();this.$body.removeAttr("contentEditable");var f=a("<div>");this.lastRange=this.getRange();f.attr("contenteditable","true").attr("class","paste").appendTo(this.body).focus();setTimeout(a.proxy(function(){this.clearPaste(f);var e=f.html();f.remove();this.$body.attr("contentEditable","true");this.body.focus();this.insertAtCursor(e,false);this.lastRange=false},this),1)}},this));a(this.doc).bind("keydown",a.proxy(function(g){if(g.which==13){var f=this.isContain(this.getSelectNode(),"li");if(!f){if(g.preventDefault){g.preventDefault()}this.checkForLastBR(this.getSelectNode());this.insertAtCursor("<br/>",false)}}},this));if(this.options.tabInsert===true){a(this.doc).bind("keydown",a.proxy(function(f){if(f.which==9){if(f.preventDefault){f.preventDefault()}this.insertAtCursor('<span class="wbbtab">\uFEFF</span>',false)}},this))}a(this.doc).bind("mouseup keyup",a.proxy(this.updateUI,this));a(this.doc).bind("mousedown",a.proxy(function(f){this.checkForLastBR(f.target)},this));if(this.options.hotkeys===true){a(this.doc).bind("keydown",a.proxy(this.presskey,this))}},this)).insertAfter(this.$txtArea)}this.$editor.append('<span class="powered">Powered by <a href="http://www.wysibb.com" target="_blank">WysiBB<a/></span>');this.$txtArea.bind("mouseup keyup",a.proxy(this.updateUI,this));if(this.options.hotkeys===true){a(document).bind("keydown",a.proxy(this.presskey,this))}},buildToolbar:function(){if(this.options.toolbar===false){return false}this.$toolbar=a("<div>").addClass("wysibb-toolbar").prependTo(this.$editor);var b;a.each(this.options.buttons,a.proxy(function(e,f){var d=this.options.allButtons[f];if(e==0||f=="|"||f=="-"){if(f=="-"){this.$toolbar.append("<div>")}b=a('<div class="wysibb-toolbar-container">').appendTo(this.$toolbar)}if(d){if(d.type=="colorpicker"){this.buildColorpicker(b,f,d)}else{if(d.type=="table"){this.buildTablepicker(b,f,d)}else{if(d.type=="select"){this.buildSelect(b,f,d)}else{if(d.type=="smilebox"){this.buildSmilebox(b,f,d)}else{this.buildButton(b,f,d)}}}}}},this));this.$toolbar.find(".btn-tooltip").hover(function(){a(this).parent().css("overflow","hidden")},function(){a(this).parent().css("overflow","visible")});var c=a(document.createElement("div")).addClass("wysibb-toolbar-container modeSwitch").html('<div class="wysibb-toolbar-btn" unselectable="on"><span class="btn-inner ve-tlb-bbcode" unselectable="on"></span></div>').appendTo(this.$toolbar);c.children(".wysibb-toolbar-btn").click(a.proxy(function(d){a(d.currentTarget).toggleClass("on");this.modeSwitch()},this));if(a.browser.msie){this.$toolbar.find("*").attr("unselectable","on")}},buildButton:function(c,g,d){if(typeof(c)!="object"){c=this.$toolbar}var f=(d.buttonHTML)?a(this.strf(d.buttonHTML,this.options)).addClass("btn-inner"):this.strf('<span class="btn-inner btn-text">{text}</span>',{text:d.buttonText.replace(/</g,"&lt;")});var b=(this.options.hotkeys===true&&this.options.showHotkeys===true&&d.hotkey)?(' <span class="tthotkey">['+d.hotkey+"]</span>"):"";var e=a('<div class="wysibb-toolbar-btn wbb-'+g+'">').appendTo(c).append(f).append(this.strf('<span class="btn-tooltip">{title}<ins/>{hotkey}</span>',{title:d.title,hotkey:b}));this.controllers.push(e);e.bind("queryState",a.proxy(function(h){(this.queryState(g))?a(h.currentTarget).addClass("on"):a(h.currentTarget).removeClass("on")},this));e.click(a.proxy(function(h){this.execCommand(g,d.exvalue||false);a(h.currentTarget).trigger("queryState")},this));e.mousedown(function(h){if(h.preventDefault){h.preventDefault()}})},buildColorpicker:function(b,c,e){var k=a('<div class="wysibb-toolbar-btn wbb-dropdown wbb-cp">').appendTo(b).append('<div class="ve-tlb-colorpick"><span class="cp-line"></span></div><ins class="ar"/>').append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:e.title}));var f=k.find(".cp-line");var h=a('<div class="wbb-list">').appendTo(k);h.append('<div class="nc">'+CURLANG.auto+"</div>");var d=(e.colors)?e.colors.split(","):[];for(var g=0;g<d.length;g++){d[g]=a.trim(d[g]);if(d[g]=="-"){h.append('<span class="pl"></span>')}else{h.append(this.strf('<div class="sc" style="background:{color}" title="{color}"></div>',{color:d[g]}))}}var i=a(document.body).css("color");this.controllers.push(k);k.bind("queryState",a.proxy(function(l){f.css("background-color",i);var j=this.queryState("fontcolor",true);if(j){f.css("background-color",(this.options.bbmode)?j.color:j)}},this));k.click(a.proxy(function(j){this.dropdownclick(".wbb-cp",".wbb-list",j)},this));k.find(".sc").click(a.proxy(function(j){var l=a(j.currentTarget).attr("title");this.execCommand("fontcolor",l);k.trigger("queryState");if(a.browser.msie){this.lastRange=false}},this));k.find(".nc").click(a.proxy(function(j){this.execCommand("fontcolor",i);k.trigger("queryState")},this));k.mousedown(function(j){if(j.preventDefault){j.preventDefault()}})},buildTablepicker:function(b,c,d){var l=a('<div class="wysibb-toolbar-btn wbb-dropdown wbb-tbl">').appendTo(b).append('<span class="btn-inner ve-tlb-table"></span><ins class="ar"/>').append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:d.title}));var i=a('<div class="wbb-list">').appendTo(l);var n=d.rows||10;var k=d.cols||10;var m=n*k;i.css("width",(k*d.cellwidth+2)+"px").css("height",(n*d.cellwidth+2)+"px");for(var e=1;e<=k;e++){for(var g=1;g<=n;g++){var f='<div class="tbl-sel" style="width:'+(e*d.cellwidth)+"px;height:"+(g*d.cellwidth)+"px;z-index:"+(--m)+'" title="'+g+","+e+'"></div>';i.append(f)}}l.find(".tbl-sel").click(a.proxy(function(s){var p=a(s.currentTarget).attr("title");var r=p.split(",");var q=(this.options.bbmode)?"[table]":'<table class="wbb-table" cellspacing="5" cellpadding="0">';for(var o=1;o<=r[0];o++){q+=(this.options.bbmode)?" [tr]\n":"<tr>";for(var h=1;h<=r[1];h++){q+=(this.options.bbmode)?"  [td][/td]\n":"<td>\uFEFF</td>"}q+=(this.options.bbmode)?"[/tr]\n":"</tr>"}q+=(this.options.bbmode)?"[/table]":"</table>";this.insertAtCursor(q)},this));l.click(a.proxy(function(h){this.dropdownclick(".wbb-tbl",".wbb-list",h)},this))},buildSelect:function(b,d,e){var l=a('<div class="wysibb-toolbar-btn wbb-select wbb-'+d+'">').appendTo(b).append(this.strf('<span class="val">{title}</span><ins class="sar"/>',e)).append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:e.title}));var f=a('<div class="wbb-list">').appendTo(l);var c=l.find("span.val");var m=(a.isArray(e.options))?e.options:e.options.split(",");for(var j=0;j<m.length;j++){var h=m[j];if(typeof(h)=="string"){var k=this.options.allButtons[h];if(k){if(k.html){a("<span>").addClass("option").attr("oid",h).attr("cmdvalue",k.exvalue).appendTo(f).append(this.strf(k.html,{seltext:k.title}))}else{f.append(this.strf('<span class="option" oid="'+h+'" cmdvalue="'+k.exvalue+'">{title}</span>',k))}}}else{var g={seltext:h.title};g[e.valueBBname]=h.exvalue;a("<span>").addClass("option").attr("oid",d).attr("cmdvalue",h.exvalue).appendTo(f).append(this.strf(e.html,g))}}this.controllers.push(l);l.bind("queryState",a.proxy(function(i){c.text(e.title);l.find(".option.selected").removeClass("selected");l.find(".option").each(a.proxy(function(p,q){var o=a(q);var s=this.queryState(o.attr("oid"),true);var n=o.attr("cmdvalue");if((n&&s==o.attr("cmdvalue"))||(!n&&s)){c.text(o.text());o.addClass("selected");return false}},this))},this));l.click(a.proxy(function(i){this.dropdownclick(".wbb-select",".wbb-list",i)},this));l.find(".option").click(a.proxy(function(p){var o=a(p.currentTarget).attr("oid");var i=a(p.currentTarget).attr("cmdvalue");var n=this.options.allButtons[o];this.execCommand(o,n.exvalue||i||false);a(p.currentTarget).trigger("queryState");if(this.lastRange){this.lastRange=false}},this))},buildSmilebox:function(b,f,c){var d=a(this.strf(c.buttonHTML,c)).addClass("btn-inner");var e=a('<div class="wysibb-toolbar-btn wbb-smilebox wbb-'+f+'">').appendTo(b).append(d).append(this.strf('<span class="btn-tooltip">{title}<ins/></span>',{title:c.title}));var g=a('<div class="wbb-list">').appendTo(e);if(a.isArray(this.options.smileList)){a.each(this.options.smileList,a.proxy(function(h,j){a("<span>").addClass("smile").appendTo(g).append(a(this.strf(j.img,this.options)).attr("title",j.title))},this))}e.click(a.proxy(function(h){this.dropdownclick(".wbb-smilebox",".wbb-list",h)},this));e.find(".smile").click(a.proxy(function(h){this.insertAtCursor((this.options.bbmode)?this.toBB(h.currentTarget):a(a(h.currentTarget).html()))},this))},updateUI:function(b){if((b.which>=8&&b.which<=46)||b.which>90||b.type=="mouseup"){a.each(this.controllers,a.proxy(function(c,d){d.trigger("queryState")},this))}if(this.options.autoresize===true){this.autoresize()}},initModal:function(){a.log("Init modal");this.$modal=a("<div>").attr("id","wbbmodal").prependTo(document.body).html('<div class="wbbm"><div class="wbbm-title"><span class="wbbm-title-text"></span><span class="wbbclose" title="'+CURLANG.close+'">×</span></div><div class="wbbm-content"></div><div class="wbbm-bottom"><button id="wbbm-submit" class="wbb-button">'+CURLANG.save+'</button><button id="wbbm-cancel" class="wbb-cancel-button">'+CURLANG.cancel+'</button><button id="wbbm-remove" class="wbb-remove-button">'+CURLANG.remove+"</button></div></div>").hide();this.$modal.find("#wbbm-cancel,.wbbclose").click(a.proxy(this.closeModal,this));this.$modal.bind("click",a.proxy(function(b){if(a(b.target).parents(".wbbm").size()==0){this.closeModal()}},this));a(document).bind("keydown",a.proxy(this.escModal,this));if(this.options.onlyBBmode!==true){a(this.doc).bind("keyup",a.proxy(this.escModal,this))}},initHotkeys:function(){a.log("initHotkeys");this.hotkeys=[];var b="0123456789       abcdefghijklmnopqrstuvwxyz";a.each(this.options.allButtons,a.proxy(function(g,e){if(e.hotkey){var f=e.hotkey.split("+");if(f&&f.length>=2){var c=0;var d=f.pop();a.each(f,function(j,h){switch(a.trim(h.toLowerCase())){case"ctrl":c+=1;break;case"shift":c+=4;break;case"alt":c+=7;break}});if(c>0){if(!this.hotkeys["m"+c]){this.hotkeys["m"+c]=[]}this.hotkeys["m"+c]["k"+(b.indexOf(d)+48)]=g}}}},this))},presskey:function(c){if(c.ctrlKey==true||c.shiftKey==true||c.altKey==true){var b=((c.ctrlKey==true)?1:0)+((c.shiftKey==true)?4:0)+((c.altKey==true)?7:0);if(this.hotkeys["m"+b]&&this.hotkeys["m"+b]["k"+c.which]){this.execCommand(this.hotkeys["m"+b]["k"+c.which],false);c.preventDefault();return false}}},execCommand:function(f,e){a.log("execCommand: "+f);var d=this.options.allButtons[f];var c=this.queryState(f,e);if(d.excmd){if(this.options.bbmode){a.log("Native command in bbmode: "+f);if(c&&d.subInsert!=true){this.wbbRemoveCallback(f,e)}else{var b={};if(d.valueBBname&&e){b[d.valueBBname]=e}this.insertAtCursor(this.getBBCodeByCommand(f,b))}}else{this.execNativeCommand(d.excmd,e||false)}}else{if(!d.cmd){this.wbbExecCommand.call(this,f,e,c)}else{d.cmd.call(this,f,e,c)}}},queryState:function(h,e){var g=this.options.allButtons[h];if(this.options.bbmode){for(var f=0;f<g.bbSelector.length;f++){var c=this.isBBContain(g.bbSelector[f]);if(c){return this.getParams(c,g.bbSelector[f],c[1])}}return false}else{if(g.excmd){if(e){var d=(this.doc.queryCommandValue(g.excmd)+"").replace(/\'/g,"");if(g.excmd=="foreColor"){d=this.rgbToHex(d)}return d}else{return this.doc.queryCommandState(g.excmd)}}else{for(var f=0;f<g.rootSelector.length;f++){var j=this.isContain(this.getSelectNode(),g.rootSelector[f]);if(j){return this.getParams(j,g.rootSelector[f])}}return false}}},wbbExecCommand:function(e,d,b){a.log("wbbExecCommand");var c=this.options.allButtons[e];if(c.modal){if(a.isFunction(c.modal)){c.modal.call(this,e,c.modal,b)}else{this.showModal.call(this,e,c.modal,b)}}else{if(b&&c.subInsert!=true){this.wbbRemoveCallback(e)}else{this.wbbInsertCallback(e,d)}}},wbbInsertCallback:function(e,d){if(typeof(d)!="object"){d={}}a.log("wbbInsertCallback: "+e);var c=this.getCodeByCommand(e,d);this.insertAtCursor(c);var b=this.getSelectNode();if(b.nodeType==3){b=b.parentNode}if(a(b).is("span,font")){this.selectNode(b)}},wbbRemoveCallback:function(e,b){a.log("wbbRemoveCallback: "+e);var c=this.options.allButtons[e];if(this.options.bbmode){var g=this.getCursorPosBB();var f=0;a.each(c.bbSelector,a.proxy(function(k,j){var l=j.match(/\{[\s\S]+?\}/g);a.each(l,function(m,i){if(i.toLowerCase()=="{seltext}"){f=m;return false}});var h=this.isBBContain(j);if(h){this.txtArea.value=this.txtArea.value.substr(0,h[1])+this.txtArea.value.substr(h[1],this.txtArea.value.length-h[1]).replace(h[0][0],(b===true)?"":h[0][f+1]);this.setCursorPosBB(h[1]);return false}},this))}else{var d=this.getSelectNode();a.each(c.rootSelector,a.proxy(function(m,x){var u=this.isContain(d,x);var r=a(u);var q=this.options.rules[x][0][1];if(r.is("span[wbb]")||!r.is("span,font")){if(b===true){r.remove()}else{if(q&&q.seltext&&q.seltext["sel"]){r.replaceWith(r.find(q.seltext["sel"]).html())}else{r.replaceWith(r.html())}}return false}else{var h=this.getRange();var o=this.getSelectText();var k=this.getSelectNode();a.log("selHTML: "+o);if(o==""){o="\uFEFF"}else{o=this.clearFromSubInsert(o,e)}var p=this.elFromString(o);var l=(window.getSelection)?h.cloneRange():this.body.createTextRange();var w=(window.getSelection)?h.cloneRange():this.body.createTextRange();if(window.getSelection){this.insertAtCursor('<span id="wbbdivide"></span>');var j=r.find("span#wbbdivide").get(0);l.setStart(u.firstChild,0);l.setEndBefore(j);w.setStartAfter(j);w.setEndAfter(u.lastChild)}else{l.moveToElementText(u);w.moveToElementText(u);l.setEndPoint("EndToStart",h);w.setEndPoint("StartToEnd",h)}var n=this.getSelectText(false,l);var v=this.getSelectText(false,w);if(v!=""){var t=r.clone().html(v);r.after(t)}if(b!==true){r.after(p)}if(window.getSelection){r.html(n);if(b!==true){this.selectNode(p)}}else{r.replaceWith(n)}return false}},this))}},execNativeCommand:function(h,j){this.body.focus();if(h=="insertHTML"&&!window.getSelection){var f=(this.lastRange)?this.lastRange:this.doc.selection.createRange();f.pasteHTML(j);var b=a("<div>").html(j).text();var d=b.indexOf("\uFEFF");if(d>-1){f.moveStart("character",(-1)*(b.length-d));f.select()}this.lastRange=false}else{if(h=="insertHTML"){var g=this.getSelection();var i=this.elFromString(j);var c=(this.lastRange)?this.lastRange:this.getRange();c.deleteContents();c.insertNode(i);c.collapse(false);g.removeAllRanges();g.addRange(c)}else{if(typeof j=="undefined"){j=false}if(this.lastRange){a.log("Last range select");this.selectRange(this.lastRange);this.lastRange=false}this.doc.execCommand(h,false,j)}}},getCodeByCommand:function(c,b){return(this.options.bbmode)?this.getBBCodeByCommand(c,b):this.getHTMLByCommand(c,b)},getBBCodeByCommand:function(f,e){if(!this.options.allButtons[f]){return""}if(typeof(e)=="undefined"){e={}}e=this.keysToLower(e);if(!e.seltext){e.seltext=this.getSelectText(true)}var b=this.options.allButtons[f].bbcode;b=this.strf(b,e);var c=null;var d=[];a.each(this.options.allButtons[f].transform,function(g,h){d.push(h)});d=this.sortArray(d,-1);a.each(d,function(h,g){var j=true;g=g.replace(/\{\S+?\}/g,function(i){i=i.substr(1,i.length-2);var k=e[i.toLowerCase()];if(!k){j=false}return k});if(j){c=g;return false}});return c||b},getHTMLByCommand:function(f,e){if(!this.options.allButtons[f]){return""}e=this.keysToLower(e);if(typeof(e)=="undefined"){e={}}if(!e.seltext){e.seltext=this.getSelectText(false);a.log("seltext: '"+e.seltext+"'");if(e.seltext==""){e.seltext="\uFEFF"}else{e.seltext=this.clearFromSubInsert(e.seltext,f)}}var b=this.options.allButtons[f].html;b=this.strf(b,e);var c=null;var d=[];a.each(this.options.allButtons[f].transform,function(g,h){d.push(g)});d=this.sortArray(d,-1);a.each(d,function(h,g){var j=true;g=g.replace(/\{\S+\}/g,function(i){i=i.substr(1,i.length-2);var k=e[i.toLowerCase()];if(!k){j=false}return k});if(j){c=g;return false}});return c||b},getSelection:function(){if(window.getSelection){return(this.options.bbmode)?window.getSelection():this.framewindow.getSelection()}else{if(document.selection){return(this.options.bbmode)?document.selection.createRange():this.doc.selection.createRange()}}},getSelectText:function(c,d){if(c){this.txtArea.focus();if("selectionStart" in this.txtArea){var b=this.txtArea.selectionEnd-this.txtArea.selectionStart;return this.txtArea.value.substr(this.txtArea.selectionStart,b)}else{var e=document.selection.createRange();return e.text}}else{this.body.focus();if(!d){d=this.getRange()}if(this.framewindow.getSelection){if(d){return a("<div>").append(d.cloneContents()).html()}}else{return d.htmlText}}return""},getRange:function(){if(window.getSelection){var c=this.getSelection();if(c.getRangeAt&&c.rangeCount>0){return c.getRangeAt(0)}else{if(c.anchorNode){var b=(this.options.bbmode)?document.createRange():this.doc.createRange();b.setStart(c.anchorNode,c.anchorOffset);b.setEnd(c.focusNode,c.focusOffset);return b}}}else{return(this.options.bbmode===true)?document.selection.createRange():this.doc.selection.createRange()}},insertAtCursor:function(e,b){if(typeof(e)!="string"){e=a("<div>").append(e).html()}if((this.options.bbmode&&typeof(b)=="undefined")||b===true){var d=e.replace(/.*(\[\/\S+?\])$/,"$1");var f=this.getCursorPosBB()+e.indexOf(d);if(document.selection){this.txtArea.focus();this.getSelection().text=e}else{if(this.txtArea.selectionStart||this.txtArea.selectionStart=="0"){this.txtArea.value=this.txtArea.value.substring(0,this.txtArea.selectionStart)+e+this.txtArea.value.substring(this.txtArea.selectionEnd,this.txtArea.value.length)}}if(f<0){f=0}this.setCursorPosBB(f)}else{this.execNativeCommand("insertHTML",e);var c=this.getSelectNode();if(!a(c).closest("table,tr,td")){this.splitPrevNext(c)}}},getSelectNode:function(b){this.body.focus();if(!b){b=this.getRange()}return(window.getSelection)?b.commonAncestorContainer:b.parentElement()},getCursorPosBB:function(){var d=0;if("selectionStart" in this.txtArea){d=this.txtArea.selectionStart}else{this.txtArea.focus();var c=this.getRange();var b=document.body.createTextRange();b.moveToElementText(this.txtArea);b.setEndPoint("EndToStart",c);d=b.text.length}return d},setCursorPosBB:function(c){if(this.options.bbmode){if(window.getSelection){this.txtArea.selectionStart=c;this.txtArea.selectionEnd=c}else{var b=this.txtArea.createTextRange();b.collapse(true);b.move("character",c);b.select()}}},selectNode:function(c,b){if(!b){b=this.getRange()}if(window.getSelection){var d=this.getSelection();b.selectNodeContents(c);d.removeAllRanges();d.addRange(b)}else{b.moveToElementText(c);b.select()}},selectRange:function(b){if(!window.getSelection){this.lastRange.select()}else{var c=this.getSelection();c.removeAllRanges();c.addRange(this.lastRange)}},filterByNode:function(g){var f=a(g);var d=f.get(0).tagName.toLowerCase();var e=d;var c=this.getAttributeList(f.get(0));a.each(c,a.proxy(function(k,m){var j=f.attr(m);if(j&&!j.match(/\{.*?\}/)){if(m=="style"){var j=f.attr(m);var l=j.split(";");a.each(l,function(n,o){if(o&&o.length>0){e+="["+m+'*="'+a.trim(o)+'"]'}})}else{e+="["+m+'="'+j+'"]'}}else{if(j&&m=="style"){var h=j.substr(0,j.indexOf("{"));if(h&&h!=""){var j=j.substr(0,j.indexOf("{"));var l=j.split(";");a.each(l,function(n,o){e+="["+m+'*="'+o+'"]'})}}}},this));var b=f.parent().children(e).index(f);if(b>0){e+=":eq("+f.index()+")"}return e},relFilterByNode:function(c,b){var d="";while(c&&c.tagName!="BODY"&&!a(c).is(b)){d=this.filterByNode(c)+" "+d;if(c){c=c.parentNode}}return d},getRegexpReplace:function(c,b){c=c.replace(/(\(|\)|\[|\]|\.|\*|\?|\:|\\)/g,"\\$1").replace(/\s+/g,"\\s+").replace(b,"(.+)").replace(/\{\S+\}/g,".*");return(c)},getBBCode:function(){if(!this.options.rules){return this.$txtArea.val()}if(this.options.bbmode){return this.$txtArea.val()}this.clearEmpty();return this.toBB(this.$body.html())},toBB:function(d){if(!d){return""}var c=(typeof(d)=="string")?a("<span>").html(d):a(d);c.find("div,blockquote,p").each(function(){if(this.nodeType!=3&&this.lastChild&&this.lastChild.tagName=="BR"){a(this.lastChild).remove()}});if(c.is("div,blockquote,p")&&c[0].nodeType!=3&&c[0].lastChild&&c[0].lastChild.tagName=="BR"){a(c[0].lastChild).remove()}c.find("ul > br, table > br, tr > br").remove();var b="";a.each(this.options.srules,a.proxy(function(e,f){c.find(e).replaceWith(f[0])},this));c.contents().each(a.proxy(function(l,h){var q=a(h);if(h.nodeType===3){b+=h.data.replace(/\n+/,"").replace(/\t/g,"   ")}else{var f,k=false;for(var e in this.options.rules){if(q.is(e)){var n=this.options.rules[e];for(var l=0;l<n.length;l++){var o=n[l][0];var j=n[l][1];var p=false,g=false,m=false;if(!q.is("br")){o=o.replace(/\n/g,"<br>")}o=o.replace(/\{(\S+?)\}/g,function(z){z=z.substr(1,z.length-2);var w=j[z.toLowerCase()];if(typeof(w)=="undefined"){a.log("Error in configuration of BBCode["+e+"]. Param: {"+z+"} not found in HTML representation.");p=true;return z}var u=(w.sel)?a(h).find(w.sel):a(h);if(w.attr&&!u.attr(w.attr)){p=true;return z}var A=(w.attr)?u.attr(w.attr):u.html();if(typeof(A)=="undefined"||A==null){p=true;return z}var v=w.rgx;if(v&&w.attr=="style"&&v.substr(v.length-1,1)!=";"){v+=";"}if(w.attr=="style"&&A&&A.substr(A.length-1,1)!=";"){A+=";"}var x=(v)?new RegExp(v,""):false;if(x){if(A.match(x)){var t=A.match(x);if(t&&t.length==2){A=t[1]}}else{A=""}}if(w.attr&&p===false){if(w.attr=="style"){g=true;var y="";var i=w.rgx.replace(/^\.\*\?/,"").replace(/\.\*$/,"").replace(/;$/,"");a(u.attr("style").split(";")).each(function(r,s){if(s&&s!=""){if(!s.match(i)){y+=s+";"}}});if(y==""){u.removeAttr("style")}else{u.attr("style",y)}}else{if(w.rgx===false){g=true;m=true;u.removeAttr(w.attr)}}}if(q.is("table,tr,td,font")){g=true}return A||""});if(p){continue}if(q.is("img,br,hr")){b+=o;break}else{if(g){if(a.browser.msie){q.empty().append(a("<span>").html(o))}else{q.empty().html("<span>"+o+"</span>")}}else{if(q.is("iframe")){b+=o}else{q.empty().html(o)}break}}}}}if(q.is("iframe")){return true}b+=this.toBB(q)}},this));return b},getHTML:function(b,c){if(!this.options.bbmode&&!c){return this.$body.html()}b=b.replace(/</g,"&lt;").replace(/\{/g,"&#123;").replace(/\}/g,"&#125;");b=b.replace(/\[code\](.*?)\[\/code\]/g,function(d){d=d.substr("[code]".length,d.length-"[code]".length-"[/code]".length).replace(/\[/g,"&#91;").replace(/\]/g,"&#93;");return"[code]"+d+"[/code]"});a.each(this.options.smileList,a.proxy(function(d,e){b=b.replace(new RegExp(this.prepareRGX(e.bbcode),"g"),this.strf(e.img,this.options))},this));a.each(this.options.btnlist,a.proxy(function(e,d){if(d!="|"&&d!="-"){var f=true;if(!this.options.allButtons[d]||!this.options.allButtons[d].transform){return true}a.each(this.options.allButtons[d].transform,a.proxy(function(i,l){i=i.replace(/\n/g,"");var g=[];a.log("BEFORE: "+l);l=l.replace(/(\(|\)|\[|\]|\.|\*|\?|\:|\\|\\)/g,"\\$1");l=l.replace(/\{\S+?\}/gi,function(n){n=n.substr(1,n.length-2);g.push(n);return"([\\s\\S]*?)"});var m=0,k;a.log("AFTER: "+l);while((k=(new RegExp(l,"mgi")).exec(b))!=null){if(k){var j={};a.each(g,a.proxy(function(o,n){j[n]=k[o+1]},this));var h=i;h=this.strf(h,j);b=b.replace(k[0],h)}}},this))}},this));a.each(this.options.systr,function(d,e){e=e.replace(/(\(|\)|\[|\]|\.|\*|\?|\:|\\|\\)/g,"\\$1").replace(" ","\\s");b=b.replace(new RegExp(e,"g"),d)});return b},setUID:function(c,b){var d="wbbid_"+(++this.lastid);a(c).attr(b||"id",d);return d},keysToLower:function(b){a.each(b,function(d,c){if(d!=d.toLowerCase()){delete b[d];b[d.toLowerCase()]=c}});return b},strf:function(c,b){b=this.keysToLower(a.extend({},b));return c.replace(/\{([\w\.]*)\}/g,function(g,d){d=d.toLowerCase();var e=d.split("."),f=b[e.shift().toLowerCase()];a.each(e,function(){f=f[this]});return(f===null||f===undefined)?"":f})},elFromString:function(d,c){if(typeof(c)=="undefined"){c=this.doc}if(d.indexOf("<")!=-1&&d.indexOf(">")!=-1){var b=c.createElement("SPAN");a(b).html(d);this.setUID(b,"wbb");return(a(b).contents().size()>1)?b:b.firstChild}else{return c.createTextNode(d)}},isContain:function(b,c){while(b&&b.tagName!="BODY"){if(a(b).is(c)){return b}if(b){b=b.parentNode}else{return null}}},isBBContain:function(f){var i=this.getCursorPosBB();var d=this.prepareRGX(f);var c=new RegExp(d,"g");var e;var g=0;while((e=c.exec(this.txtArea.value))!=null){var h=this.txtArea.value.indexOf(e[0],g);if(i>h&&i<(h+e[0].length)){return[e,h]}g=h+1}},prepareRGX:function(b){return b.replace(/(\[|\]|\)|\(|\.|\*|\?|\:|\||\\)/g,"\\$1").replace(/\{.*?\}/g,"([\\s\\S]*?)")},checkForLastBR:function(d){if(!d){c=this.body}if(d.nodeType==3){d=d.parentNode}var c=a(d);if(this.options.bbmode===false&&c.is("div,blockquote")&&c.contents().size()>0){var b=c[0].lastChild;if(!b||(b&&b.tagName!="BR")){c.append("<br/>")}}if(this.$body.contents().size()>0&&this.body.lastChild.tagName!="BR"){this.$body.append("<br/>")}},getAttributeList:function(c){var b=[];a.each(c.attributes,function(e,d){if(d.specified){b.push(d.name)}});return b},clearFromSubInsert:function(c,d){var b=a("<div>").html(c);a.each(this.options.allButtons[d].rootSelector,a.proxy(function(g,h){var e=this.options.rules[h][0][1]["seltext"]["sel"];var f=true;b.find("*").each(function(){if(a(this).is(h)){if(e&&e.sel){a(this).replaceWith(a(this).find(e.sel.toLowerCase()).html())}else{a(this).replaceWith(a(this).html())}f=false}});return f},this));return b.html()},splitPrevNext:function(b){if(b.nodeType==3){b=b.parentNode}var c=this.filterByNode(b).replace(/\:eq.*$/g,"");if(a(b.nextSibling).is(c)){a(b).append(a(b.nextSibling).html());a(b.nextSibling).remove()}if(a(b.previousSibling).is(c)){a(b).prepend(a(b.previousSibling).html());a(b.previousSibling).remove()}},modeSwitch:function(){if(this.options.bbmode){this.$body.html(this.getHTML(this.$txtArea.val()));this.$txtArea.hide();this.$iFrame.show()}else{this.$txtArea.val(this.getBBCode());this.$iFrame.hide();this.$txtArea.show()}this.options.bbmode=!this.options.bbmode},clearEmpty:function(){this.$body.children().filter(b).remove();function b(){if(!a(this).is("span,font,a")){return false}if(!a(this).hasClass("wbbtab")&&a.trim(a(this).html()).length==0){return true}else{if(a(this).children().size()>0){a(this).children().filter(b).remove();if(a(this).html().length==0&&this.tagName!="BODY"){return true}}}}},dropdownclick:function(f,b,d){var c=a(d.currentTarget).closest(f);if(c.attr("wbbshow")){c.removeAttr("wbbshow");a(document).unbind("mousedown",this.dropdownhandler);if(this.doc){a(this.doc).unbind("mousedown",this.dropdownhandler)}}else{this.$editor.find("*[wbbshow]").each(function(e,g){a(g).removeClass("on").find(a(g).attr("wbbshow")).hide().end().removeAttr("wbbshow")});c.attr("wbbshow",b);a(document.body).bind("mousedown",a.proxy(function(e){this.dropdownhandler(c,f,b,e)},this));if(this.$body){this.$body.bind("mousedown",a.proxy(function(e){this.dropdownhandler(c,f,b,e)},this))}}c.find(b).toggle();c.toggleClass("on")},dropdownhandler:function(c,f,b,d){if(a(d.target).parents(f).size()==0){c.removeClass("on").find(b).hide();a(document).unbind("mousedown",this.dropdownhandler);if(this.$body){this.$body.unbind("mousedown",this.dropdownhandler)}}},rgbToHex:function(c){if(c.substr(0,1)=="#"){return c}if(c.indexOf("rgb")==-1){var b=parseInt(c);b=((b&255)<<16)|(b&65280)|((b&16711680)>>>16);return"#"+b.toString(16)}var d=/(.*?)rgb\((\d+),\s*(\d+),\s*(\d+)\)/.exec(c);return"#"+this.dec2hex(parseInt(d[2]))+this.dec2hex(parseInt(d[3]))+this.dec2hex(parseInt(d[4]))},dec2hex:function(b){if(b>15){return b.toString(16)}else{return"0"+b.toString(16)}},sync:function(){if(this.options.bbmode){this.$body.html(this.getHTML(this.txtArea.value,true))}else{this.$txtArea.val(this.getBBCode())}},clearPaste:function(b){a.log("Paste");var c=a(b);a.each(this.options.rules,a.proxy(function(d,e){c.find(d).attr("wbbkeep",1)},this));c.find("*[wbbkeep!='1']").each(a.proxy(function(d,e){var f=a(e);if(f.is("div,p")&&(f.children()==0||e.lastChild.tagName!="BR")){f.after("<br/>").after(f.contents()).remove()}else{f.after(f.html()).remove()}},this));c.find("*[wbbkeep]").removeAttr("wbbkeep").removeAttr("style")},sortArray:function(b,c){b.sort(function(e,d){return(e.length-d.length)*(c||1)});return b},smileFind:function(){if(this.options.smilefind){var b=a(this.options.smilefind).find("img[alt]");if(b.size()>0){this.options.smileList=[];b.each(a.proxy(function(d,e){var c=a(e);this.options.smileList.push({title:c.attr("title"),bbcode:c.attr("alt"),img:c.removeAttr("alt").removeAttr("title")[0].outerHTML})},this))}}},destroy:function(){this.$editor.replaceWith(this.$txtArea);this.$txtArea.removeClass("wysibb-texarea").show();this.$modal.remove();this.$txtArea.data("wbb",null)},autoresize:function(){clearTimeout(this.resizeTimer);this.resizeTimer=setTimeout(a.proxy(function(){var b=this.$iFrame.outerHeight();var c=this.$body.outerHeight();if(c>b){if(c>this.options.resize_maxheight){c=this.options.resize_maxheight}this.$iFrame.height((c+30)+"px");this.$txtArea.height((c+30)+"px")}},this),200)},showModal:function(h,e,c){a.log("showModal: "+h);var g=this.$modal.find(".wbbm-content").html("");var d=this.$modal.find(".wbbm").removeClass("hastabs");this.$modal.find("span.wbbm-title-text").html(e.title);if(e.tabs&&e.tabs.length>1){d.addClass("hastabs");var b=a('<div class="wbbm-tablist">').appendTo(g).append("<ul>").children("ul");a.each(e.tabs,a.proxy(function(j,k){if(j==0){k.on="on"}b.append(this.strf("<li class=\"{on}\" onClick=\"$(this).parent().find('.on').removeClass('on');$(this).addClass('on');$(this).parents('.wbbm-content').find('.tab-cont').hide();$(this).parents('.wbbm-content').find('.tab"+j+"').show()\">{title}</li>",k))},this))}if(e.width){d.css("width",e.width)}var f=a('<div class="wbbm-cont">').appendTo(g);if(c){d.find("#wbbm-remove").show()}else{d.find("#wbbm-remove").hide()}a.each(e.tabs,a.proxy(function(j,l){var k=a("<div>").addClass("tab-cont tab"+j).attr("tid",j).appendTo(f);if(j>0){k.hide()}if(l.html){k.html(this.strf(l.html,this.options))}else{a.each(l.input,a.proxy(function(i,m){m.value=c[m.param.toLowerCase()];if(m.param.toLowerCase()=="seltext"&&(!m.value||m.value=="")){m.value=this.getSelectText(this.options.bbmode)}k.append(this.strf('<div class="wbbm-inp-row"><label>{title}</label><input class="modal-text" type="text" name="{param}" value="{value}"/></div>',m))},this))}},this));this.lastRange=this.getRange();if(a.isFunction(e.onLoad)){e.onLoad.call(this,h,e,c)}d.find("#wbbm-submit").click(a.proxy(function(){if(a.isFunction(e.onSubmit)){var j=e.onSubmit.call(this,h,e,c);if(j===false){return}}var k={};var i=true;this.$modal.find(".wbbm-inperr").remove();this.$modal.find(".wbbm-brdred").removeClass("wbbm-brdred");a.each(this.$modal.find(".tab-cont:visible input"),a.proxy(function(o,p){var q=a(p).parents(".tab-cont").attr("tid");var n=a(p).attr("name").toLowerCase();var m=a(p).val();var l=e.tabs[q]["input"][o]["validation"];if(typeof(l)!="undefined"){if(!m.match(new RegExp(l,"i"))){i=false;a(p).after('<span class="wbbm-inperr">'+CURLANG.validation_err+"</span>").addClass("wbbm-brdred")}}k[n]=m},this));if(i){if(this.lastRange){this.selectRange(this.lastRange)}if(c){this.wbbRemoveCallback(h,true)}this.wbbInsertCallback(h,k);this.closeModal();this.updateUI()}},this));d.find("#wbbm-remove").click(a.proxy(function(){this.wbbRemoveCallback(h);this.closeModal();this.updateUI()},this));a(document.body).css("overflow","hidden");if(a(document.body).height()>a(window).height()){a(document.body).css("padding-right","20px")}this.$modal.show();d.css("margin-top",(a(window).height()-d.outerHeight())/3+"px");setTimeout(a.proxy(function(){this.$modal.find("input:visible")[0].focus()},this),10)},escModal:function(b){if(b.which==27){this.closeModal()}},closeModal:function(){a(document.body).css("overflow","auto").css("padding-right","0").unbind("keyup",this.escModal);this.$modal.find("#wbbm-submit,#wbbm-remove").unbind("click");this.$modal.hide();this.lastRange=false;return this},getParams:function(b,j,e){var d={};if(this.options.bbmode){var i=j.match(/\{[\s\S]+?\}/g);j=this.prepareRGX(j);var f=new RegExp(j,"g");var c=this.txtArea.value;if(e>0){c=c.substr(e,c.length-e)}var g=f.exec(c);if(g){a.each(i,function(k,l){d[l.replace(/\{|\}/g,"").replace(/"/g,"'").toLowerCase()]=g[k+1]})}}else{var h=this.options.rules[j][0][1];a.each(h,a.proxy(function(o,n){var p="";if(n.attr!==false){p=a(b).attr(n.attr)}else{if(n.sel!==false){p=a(b).find(n.sel).html()}else{p=a(b).html()}}if(p){if(n.rgx!==false){var l=p.match(new RegExp(n.rgx));if(l&&l.length==2){p=l[1]}}d[o]=p.replace(/"/g,"'")}},this))}return d},imgLoadModal:function(){a.log("imgLoadModal");if(this.options.imgupload===true){this.$modal.find("#imguploader").dragfileupload({url:this.strf(this.options.img_uploadurl,this.options),extraParams:{maxwidth:this.options.img_maxwidth,maxheight:this.options.img_maxheight},themePrefix:this.options.themePrefix,themeName:this.options.themeName,success:a.proxy(function(b){this.$txtArea.insertImage(b.image_link,b.thumb_link);this.closeModal();this.updateUI()},this)});if(a.browser.msie){a.log("IE not posting form by security reason, show default file upload");this.$modal.find("#nicebtn").hide();this.$modal.find("#fileupl").css("opacity",1)}this.$modal.find("#fileupl").bind("change",function(){a("#fupform").submit()});this.$modal.find("#fupform").bind("submit",a.proxy(function(b){a(b.target).parents("#imguploader").hide().after('<div class="loader"><img src="'+this.options.themePrefix+"/"+this.options.themeName+'/img/loader.gif" /><br/><span>'+CURLANG.loading+"</span></div>").parent().css("text-align","center")},this))}else{this.$modal.find(".hastabs").removeClass("hastabs");this.$modal.find("#imguploader").parents(".tab-cont").remove();this.$modal.find(".wbbm-tablist").remove()}},imgSubmitModal:function(){a.log("imgSubmitModal")},printObjectInIE:function(c){try{a.log(JSON.stringify(c))}catch(b){}},checkFilter:function(c,b){a.log("node: "+a(c).get(0).outerHTML+" filter: "+b+" res: "+a(c).is(b.toLowerCase()))},debug:function(c){var b=(new Date()).getTime();if(typeof(console)!="undefined"){console.log((b-this.startTime)+" ms: "+c)}else{a("#exlog").append("<p>"+(b-this.startTime)+" ms: "+c+"</p>")}this.startTime=b}};a.log=function(b){if(typeof(console)!="undefined"){console.log(b)}else{a("#exlog").append("<p>"+b+"</p>")}};a.fn.wysibb=function(b){return this.each(function(){var c=a(this).data("wbb");if(!c){a.log("Create WysiBB object");new a.wysibb(this,b)}})};a.fn.getDoc=function(){return this.data("wbb").doc};a.fn.getSelectText=function(b){return this.data("wbb").getSelectText(b)};a.fn.bbcode=function(b){if(b){this.data("wbb").$txtArea.val(b);return this}else{return this.data("wbb").getBBCode()}};a.fn.htmlcode=function(b){if(b){this.data("wbb").$body.html(b);return this}else{return this.data("wbb").getHTML(this.data("wbb").$txtArea.val())}};a.fn.getBBCode=function(){return this.data("wbb").getBBCode()};a.fn.getHTML=function(){var b=this.data("wbb");return b.getHTML(b.$txtArea.val())};a.fn.getHTMLByCommand=function(c,b){return this.data("wbb").getHTMLByCommand(c,b)};a.fn.getBBCodeByCommand=function(c,b){return this.data("wbb").getBBCodeByCommand(c,b)};a.fn.insertAtCursor=function(c,b){this.data("wbb").insertAtCursor(c,b)};a.fn.execCommand=function(c,b){this.data("wbb").execCommand(c,b)};a.fn.insertImage=function(c,b){var d=this.data("wbb");var e=(b)?d.getCodeByCommand("link",{url:c,seltext:d.getCodeByCommand("img",{src:b})}):d.getCodeByCommand("img",{src:c});this.insertAtCursor(e);return d};a.fn.sync=function(){this.data("wbb").sync()};a.fn.destroy=function(){this.data("wbb").destroy()};a.fn.queryState=function(b){this.data("wbb").queryState(b)}})(jQuery);(function(b){b.fn.dragfileupload=function(c){return this.each(function(){var d=new a(this,c);d.init()})};function a(d,c){this.$block=b(d);this.opt=b.extend({url:false,success:false,extraParams:false,fileParam:"img",validation:".(jpg|png|gif|jpeg)$",t1:CURLANG.fileupload_text1,t2:CURLANG.fileupload_text2},c);b.log(this.opt)}a.prototype={init:function(){if(window.FormData!=null){b.log("Init drag&drop file upload");this.$block.addClass("drag");this.$block.prepend('<div class="p2">'+this.opt.t2+"</div>");this.$block.prepend('<div class="p">'+this.opt.t1+"</div>");this.$block.bind("dragover",function(){b(this).addClass("dragover")});this.$block.bind("dragleave",function(){b(this).removeClass("dragover")});var d=b.proxy(function(g){var f=parseInt(g.loaded/g.total*100,10);this.$loader.children("span").text(CURLANG.loading+": "+f+"%")},this);var c=jQuery.ajaxSettings.xhr();if(c.upload){c.upload.addEventListener("progress",d,false)}this.$block[0].ondrop=b.proxy(function(h){h.preventDefault();this.$block.removeClass("dragover");var g=h.dataTransfer.files[0];if(!g.name.match(new RegExp(this.opt.validation))){this.error(CURLANG.validation_err);return false}var f=new FormData();f.append(this.opt.fileParam,g);if(this.opt.extraParams){b.each(this.opt.extraParams,function(i,e){f.append(i,e)})}this.$loader=b('<div class="loader"><img src="'+this.opt.themePrefix+"/"+this.opt.themeName+'/img/loader.gif" /><br/><span>'+CURLANG.loading+"</span></div>");this.$block.html(this.$loader);b.ajax({type:"POST",url:this.opt.url,data:f,processData:false,contentType:false,xhr:function(){return c},dataType:"json",success:b.proxy(function(e){if(e&&e.status==1){this.opt.success(e)}else{this.error(e.msg||CURLANG.error_onupload)}},this),error:b.proxy(function(j,e,i){this.error(CURLANG.error_onupload)},this)})},this)}},error:function(c){this.$block.find(".upl-error").remove().end().append('<span class="upl-error">'+c+"</span>").addClass("wbbm-brdred")}}})(jQuery);